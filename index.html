<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¯Œè±ªæ¨¡æ‹Ÿå™¨ V7.1 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* å…¨å±€è®¾å®š */
        body,
        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #050505;
            color: #e5e5e5;
            font-family: 'Noto Serif SC', serif;
        }
 
        .mono {
            font-family: 'JetBrains+Mono', monospace;
        }
 
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
 
        /* åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
 
        .slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
 
        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
 
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
 
            to {
                opacity: 1;
            }
        }
 
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
 
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
 
        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
 
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
 
        /* æµ®åŠ¨æ•°å€¼ */
        @keyframes floatChange {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
 
            100% {
                transform: translateY(-50px) scale(1.1);
                opacity: 0;
            }
        }
 
        .float-anim {
            animation: floatChange 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
 
        /* ç»“ç®—å°ç¥¨æ ·å¼ */
        .receipt-bg {
            background-color: #fff;
            background-image: radial-gradient(#eee 1px, transparent 1px);
            background-size: 10px 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
 
        .jagged-edge {
            background: linear-gradient(-45deg, transparent 8px, #fff 8px), linear-gradient(45deg, transparent 8px, #fff 8px);
            background-size: 16px 16px;
            background-repeat: repeat-x;
            height: 16px;
            width: 100%;
        }
    </style>
</head>
 
<body class="flex flex-col h-full bg-gray-950">
 
    <!-- 1. åˆå§‹åŒ–å¼¹çª— -->
    <div id="initModal"
        class="fixed inset-0 z-[60] bg-black flex flex-col justify-center px-6 transition-opacity duration-500">
        <div
            class="w-full max-w-md mx-auto bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-2xl space-y-6 relative overflow-hidden">
            <!-- è£…é¥°å…‰æ–‘ -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-600 rounded-full blur-[50px] opacity-20"></div>
 
            <div class="text-center relative z-10">
                <h1
                    class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 tracking-wider">
                    æ¬²æœ›éƒ½å¸‚</h1>
                <p class="text-xs text-gray-500 mt-2 tracking-[0.2em] uppercase">Wealth & Desire Simulator V7.1</p>
            </div>
 
            <div class="space-y-4 relative z-10">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1 uppercase">Gender</label>
                        <select id="genderInput"
                            class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600 appearance-none">
                            <option value="male">ç”· (Male)</option>
                            <option value="female">å¥³ (Female)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1 uppercase">Original Job</label>
                        <input type="text" id="jobInput" placeholder="ä¾‹: è‹¦é€¼è®¾è®¡å¸ˆ"
                            class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1 uppercase">API Key (DeepSeek/OpenAI)</label>
                    <input type="text" id="apiKeyInput" placeholder="sk-a4c9e0a162024086b8d3fca50a0c6e2a"
                        class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600">
                    <script>
                        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
                        window.addEventListener('load', function () {
                            const input = document.getElementById('apiKeyInput');
                            // å°† placeholder çš„å€¼è®¾ç½®ä¸º input çš„é»˜è®¤å€¼
                            input.value = input.placeholder;
                        });
                    </script>
                </div>
                <!-- éšè—çš„é«˜çº§è®¾ç½® -->
                <input type="text" id="apiBaseUrl" value="https://api.deepseek.com"
                    class="w-full bg-transparent border-b border-gray-800 text-[10px] text-gray-700 p-1 text-center outline-none">
            </div>
 
            <button onclick="startGame()"
                class="w-full bg-gradient-to-r from-yellow-700 to-yellow-600 text-white font-bold py-4 rounded-xl shadow-[0_4px_15px_rgba(202,138,4,0.3)] active:scale-95 transition-transform relative z-10">
                å¼€å¯ç¬¬äºŒäººç”Ÿ â¤
            </button>
        </div>
    </div>
 
    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameUI" class="hidden flex-col h-full w-full max-w-lg mx-auto relative overflow-hidden bg-[#0a0a0a]">
 
        <!-- A. é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="flex-none bg-gray-900/90 border-b border-gray-800 p-3 z-30 backdrop-blur-md">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3" onclick="toggleProfile()">
                    <div class="relative">
                        <div class="w-11 h-11 rounded-full p-[2px] bg-gradient-to-tr from-yellow-500 to-transparent">
                            <img id="headerAvatar" src="" class="w-full h-full rounded-full object-cover bg-gray-800">
                        </div>
                        <!-- å¾½ç« æç¤ºçº¢ç‚¹ -->
                        <div id="badgeDot"
                            class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900">
                        </div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase">Total Assets</div>
                        <div id="moneyDisplay" class="font-mono font-bold text-lg text-yellow-400 leading-none">
                            10,000,000</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase">Age</div>
                    <div id="ageDisplay" class="font-serif font-bold text-xl text-white leading-none">22</div>
                </div>
            </div>
 
            <!-- å±æ€§æ¡ -->
            <div class="grid grid-cols-3 gap-3">
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] text-gray-400"><span>å¿«ä¹</span><span
                            id="valHappy">80</span></div>
                    <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                        <div id="barHappy" class="h-full bg-pink-500 transition-all duration-700" style="width: 80%">
                        </div>
                    </div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] text-gray-400"><span>å¥åº·</span><span
                            id="valHealth">90</span></div>
                    <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                        <div id="barHealth" class="h-full bg-emerald-500 transition-all duration-700"
                            style="width: 90%"></div>
                    </div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] text-gray-400"><span>åå£°</span><span
                            id="valRep">50</span></div>
                    <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                        <div id="barRep" class="h-full bg-blue-500 transition-all duration-700" style="width: 50%">
                        </div>
                    </div>
                </div>
            </div>
        </header>
 
        <!-- B. å‰§æƒ…æµ (è‡ªé€‚åº”æ»šåŠ¨) -->
        <main id="storyContainer" class="flex-1 min-h-0 overflow-y-auto p-4 relative scroll-smooth bg-[#0a0a0a]">
            <div class="text-center text-gray-800 text-xs mt-6 mb-8 font-mono">--- TIMELINE STARTED ---</div>
            <div id="storyLog" class="space-y-6"></div>
            <!-- åº•éƒ¨å«é«˜ -->
            <div class="h-32 w-full flex-shrink-0"></div>
        </main>
 
        <!-- æµ®åŠ¨ç‰¹æ•ˆå±‚ -->
        <div id="floatOverlay" class="absolute inset-0 pointer-events-none overflow-hidden z-40"></div>
 
        <!-- C. åº•éƒ¨æ“ä½œæ  -->
        <footer class="flex-none bg-gray-900 border-t border-gray-800 p-4 z-30 pb-8">
            <div id="loadingBox" class="hidden w-full py-4 text-center">
                <span class="text-yellow-600 text-xs font-mono animate-pulse tracking-widest">>>> AI IS
                    PLOTTING...</span>
            </div>
            <div id="choicesBox" class="flex flex-col gap-2.5 max-h-[45vh] overflow-y-auto no-scrollbar"></div>
        </footer>
 
        <!-- ä¸ªäººä¸­å¿ƒ / é‡Œç¨‹ç¢‘æŠ½å±‰ -->
        <div id="profileDrawer"
            class="absolute inset-0 bg-black/95 z-50 hidden flex-col items-center justify-center p-6 backdrop-blur-md transition-opacity"
            onclick="toggleProfile()">
            <div class="w-full max-w-sm bg-gray-900 p-6 rounded-2xl border border-gray-700 shadow-2xl"
                onclick="event.stopPropagation()">
                <div class="text-center mb-6">
                    <img id="drawerAvatar" src=""
                        class="w-24 h-24 rounded-full mx-auto border-2 border-yellow-600 mb-3 shadow-[0_0_15px_rgba(202,138,4,0.3)]">
                    <h2 class="text-xl font-bold text-white" id="drawerJob">æ— ä¸š</h2>
                </div>
 
                <div class="mb-2 text-xs text-gray-500 uppercase tracking-widest font-bold">Milestones / æˆå°±</div>
                <div id="milestoneList"
                    class="flex flex-wrap gap-2 max-h-48 overflow-y-auto bg-black/50 p-3 rounded-lg min-h-[100px] content-start">
                    <!-- åŠ¨æ€æ’å…¥å¾½ç«  -->
                </div>
 
                <div class="mt-6 text-center">
                    <button onclick="toggleProfile()"
                        class="text-gray-500 text-xs border border-gray-700 px-6 py-2 rounded-full hover:text-white hover:border-white transition">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
 
    <!-- 3. ç»“ç®—å°ç¥¨ (Resume/Receipt) -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-gray-900 z-[70] overflow-y-auto flex items-start justify-center pt-10 pb-10">
        <div class="receipt-bg text-black font-mono w-[90%] max-w-md shadow-2xl relative transform transition-all duration-700 translate-y-10 opacity-0 fade-in"
            style="opacity:1; transform:translateY(0)">
            <!-- é¡¶éƒ¨é”¯é½¿ -->
            <div class="jagged-edge absolute -top-4 left-0 transform rotate-180"></div>
 
            <div class="p-6 pb-10">
                <div class="text-center border-b-2 border-black pb-4 mb-4">
                    <h2 class="text-3xl font-black uppercase tracking-tighter">äººç”Ÿç»“ç®—å•</h2>
                    <p class="text-[10px] text-gray-500 mt-1">LIFE SIMULATION OFFICIAL RECEIPT</p>
                    <div class="text-right text-[10px] mt-2">DATE: 2026/01/18</div>
                </div>
 
                <div class="space-y-2 text-xs mb-6 font-bold text-gray-800">
                    <div class="flex justify-between"><span>NAME</span><span id="endName">---</span></div>
                    <div class="flex justify-between"><span>JOB</span><span id="endJob">---</span></div>
                    <div class="flex justify-between"><span>AGE</span><span id="endAge">---</span></div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-dashed border-gray-400">
                        <span>ENDING</span>
                        <span class="bg-black text-white px-2 py-0.5 text-sm" id="endTitle">---</span>
                    </div>
                </div>
 
                <div class="mb-6">
                    <div class="text-[10px] font-bold border-b border-black mb-2">TIMELINE LOG</div>
                    <ul id="endTimeline" class="text-[10px] space-y-1.5 leading-tight text-gray-600 list-none"></ul>
                </div>
 
                <div class="border-t-4 border-black pt-4 mb-6">
                    <div class="flex justify-between items-end">
                        <span class="text-xs font-bold">TOTAL ASSETS</span>
                        <span class="text-xl font-black" id="endMoney">Â¥0</span>
                    </div>
                    <div class="flex justify-between items-end mt-1">
                        <span class="text-xs font-bold">SCORE</span>
                        <span class="text-xl font-black" id="endRank">C</span>
                    </div>
                </div>
 
                <!-- æ¨¡æ‹Ÿæ¡å½¢ç åŒºåŸŸ -->
                <div class="text-center opacity-80">
                    <div class="h-8 bg-current w-3/4 mx-auto mb-1"
                        style="mask: repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 4px);">
                    </div>
                    <p class="text-[8px]">THANK YOU FOR PLAYING</p>
                </div>
            </div>
 
            <!-- åº•éƒ¨é”¯é½¿ -->
            <div class="jagged-edge absolute -bottom-4 left-0"></div>
        </div>
 
        <div class="fixed bottom-6 w-full px-6 max-w-md">
            <button onclick="location.reload()"
                class="w-full bg-yellow-500 text-black font-bold py-4 rounded-xl shadow-xl hover:bg-yellow-400 transition">
                é‡å¯äººç”Ÿ (RESTART)
            </button>
        </div>
    </div>
 
    <script>
        // --- æ¸¸æˆé…ç½®ä¸äº‹ä»¶åº“ ---
        const CONFIG = { avatarHost: "https://api.dicebear.com/9.x/notionists/svg" };
 
        const GLOBAL_EVENTS = [
            { id: "scam", text: "ã€æ€çŒªç›˜ã€‘ä½ åœ¨ç½‘ä¸Šè®¤è¯†çš„'å®Œç¾ä¼´ä¾£'çªç„¶å¤±è”ï¼Œä½ çš„æŠ•èµ„è´¦æˆ·æ— æ³•æç°..." },
            { id: "health_crisis", text: "ã€å¥åº·æš´é›·ã€‘å› ä¸ºé•¿æœŸçš„çºµæ¬²å’Œç†¬å¤œï¼Œä½ åœ¨å¤œåº—çªç„¶æ™•å€’ï¼Œè¢«é€è¿›äº†ICU..." },
            { id: "tax_audit", text: "ã€ç¨åŠ¡ç¨½æŸ¥ã€‘ç¨åŠ¡å±€çªç„¶ä¸Šé—¨ï¼Œè´¨ç–‘ä½ å·¨é¢è´¢äº§çš„æ¥æºï¼Œå†»ç»“äº†ä½ çš„éƒ¨åˆ†èµ„äº§..." },
            { id: "relative", text: "ã€äº²æˆšå¸è¡€ã€‘ä½ å…«ç«¿å­æ‰“ä¸ç€çš„è¿œæˆ¿è¡¨èˆ…å¸¦ç€å…¨å®¶è€å°æ¥æŠ•å¥”ä½ ï¼Œèµ–åœ¨ä½ çš„åˆ«å¢…ä¸èµ°..." },
            { id: "market_crash", text: "ã€é‡‘èæµ·å•¸ã€‘å…¨çƒè‚¡å¸‚ç†”æ–­ï¼Œä½ æŒæœ‰çš„ç§‘æŠ€è‚¡å’Œè™šæ‹Ÿè´§å¸ä¸€å¤œå½’é›¶..." },
            { id: "blackmail", text: "ã€æ¡ƒè‰²é™·é˜±ã€‘ä½ æ˜¨æ™šå¸¦å›å®¶çš„ä¼´ä¾£ï¼Œç¬¬äºŒå¤©å£°ç§°æœªæˆå¹´å¹¶æ‹äº†ç…§ï¼Œå‘ä½ å‹’ç´¢å·¨æ¬¾..." }
        ];
 
        let state = {
            money: 100000000, happiness: 80, health: 90, reputation: 50, age: 22,
            gender: 'male', originalJob: '',
            milestones: [], timeline: [], history: []
        };
        let api = { key: '', url: '' };
 
        // --- æ ¸å¿ƒé€»è¾‘ ---
 
        function startGame() {
            const job = document.getElementById('jobInput').value.trim();
            const key = document.getElementById('apiKeyInput').value.trim();
            let url = document.getElementById('apiBaseUrl').value.trim();
 
            if (!job || !key) { alert("è¯·å®Œå–„ä¿¡æ¯ï¼"); return; }
            if (url.endsWith('/')) url = url.slice(0, -1);
            if (!url.endsWith('/v1')) url += '/v1';
 
            state.originalJob = job;
            state.gender = document.getElementById('genderInput').value;
            api = { key, url };
 
            const modal = document.getElementById('initModal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                const gameUI = document.getElementById('gameUI');
                gameUI.classList.remove('hidden');
                gameUI.classList.add('flex');
 
                updateUI();
                document.getElementById('drawerJob').innerText = job;
 
                initGameStory();
            }, 500);
        }
 
        function initGameStory() {
            const genderDesire = state.gender === 'male'
                ? "éšæœºç”Ÿæˆ'åŒ…å…»å«©æ¨¡ã€å»å¤œæ€»ä¼šã€è¿½æ±‚å¥³å¤§å­¦ç”Ÿã€è´­ä¹°è±ªè½¦'ç­‰æ»¡è¶³ç”·æ€§è™šè£ä¸è‰²æ¬²çš„é€‰é¡¹ã€‚"
                : "éšæœºç”Ÿæˆ'åŒ…å…»å°å¥¶ç‹—ã€ç‚¹ç”·æ¨¡ã€è´­ä¹°çˆ±é©¬ä»•ã€æ•´å®¹åŒ»ç¾'ç­‰æ»¡è¶³å¥³æ€§è™šè£ä¸æƒ…æ„Ÿéœ€æ±‚çš„é€‰é¡¹ã€‚";
 
            // ä¿®æ­£åçš„ Promptï¼šå¼ºåˆ¶è¦æ±‚æ•°å€¼å‡†ç¡®æ€§
            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ª"å¯Œè±ªæ¨¡æ‹Ÿå™¨"çš„æ¸¸æˆå¼•æ“ã€‚
ç©å®¶è®¾å®šï¼š${state.gender}ï¼Œ22å²ï¼ŒåŸèŒä¸šï¼š${state.originalJob}ï¼Œåˆå§‹ä¸­å¥–1ä¸ªäº¿ã€‚
 
**æ ¸å¿ƒæŒ‡ä»¤**ï¼š
1. **é‡Šæ”¾äººæ€§è´ªå©ª**ï¼š${genderDesire}
2. **æ•°å€¼ç²¾ç¡®è®¡ç®—ï¼ˆé‡è¦ï¼‰**ï¼š
   - æ¶‰åŠé‡‘é¢å˜åŠ¨æ—¶ï¼Œdiff.money å¿…é¡»æ˜¯**çº¯æ•°å­—æ•´æ•°**ï¼ˆå•ä½ï¼šå…ƒï¼‰ã€‚
   - **ä¸¥ç¦**ä½¿ç”¨ "w", "ä¸‡", "k" ç­‰åç¼€ã€‚
   - ä¾‹å¦‚ï¼šä¹°æˆ¿æ‰£é™¤500ä¸‡ï¼Œè¿”å› -5000000ã€‚å»å¤œåº—æ¶ˆè´¹5ä¸‡ï¼Œè¿”å› -50000ã€‚
   - å¿…é¡»åŸºäºå¸¸è¯†å®šä»·ï¼šè±ªå®…500ä¸‡-1äº¿ï¼Œè±ªè½¦100ä¸‡-2000ä¸‡ï¼Œå¤œåº—æ¶ˆè´¹1ä¸‡-50ä¸‡ã€‚
3. **JSONæ ¼å¼**ï¼šå¿…é¡»è¿”å›ä¸¥æ ¼JSONã€‚
4. **é€‰é¡¹è¦æ±‚**ï¼šoptions æ•°ç»„å¿…é¡»åŒ…å« 3-4 ä¸ªé€‰é¡¹ã€‚
5. **åˆå§‹é€‰æ‹©**ï¼šåˆå§‹é€‰æ‹©å»ºè®®ä»ã€Œè¾èŒæ—…æ¸¸ã€ã€ã€Œä¹°è±ªè½¦/å¥¢ä¾ˆå“ã€ã€ã€Œå¤œæ€»ä¼šæŒ¥éœã€ã€ã€ŒæŠ•èµ„/å­˜é“¶è¡Œ/ä¹°æˆ¿ã€å’Œè‡ªå·±å…´è¶£ç›¸å…³çš„æ¶ˆè´¹å¼€å§‹ï¼Œç”¨æˆ·éšç€æ—¶é—´ä¸€æ­¥ä¸€æ­¥é™·å…¥äººæ€§é™·é˜±
 
JSONç»“æ„ï¼š
{
    "story": "å‰§æƒ…(100å­—ï¼Œé»‘è‰²å¹½é»˜é£æ ¼)",
    "timeline": "ç®€å†æ‘˜è¦(å¦‚: 23å²ï¼Œæ²‰è¿·å¤œåº—æŒ¥éœ50ä¸‡)",
    "diff": { "money": 0, "happiness": 0, "health": 0, "reputation": 0, "age": 0.5 },
    "new_milestones": [],
    "options": ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C"],
    "game_over": false,
    "ending": { "title": "...", "rank": "B" }
}
`;
            state.history = [
                { role: "system", content: systemPrompt },
                { role: "user", content: "æ¸¸æˆå¼€å§‹ã€‚ç¬¬ä¸€å¹•ï¼šä»Šæ—©ä½ å…‘æ¢äº†æ˜¨å¤©ä¸€äº¿çš„å½©ç¥¨å¤§å¥–ï¼Œçœ‹ç€é“¶è¡Œå¡ä½™é¢ï¼Œæˆ‘äº§ç”Ÿäº†å¤§èƒ†çš„æƒ³æ³•ã€‚" }
            ];
            fetchTurn();
        }
 
        async function fetchTurn(choice = null) {
            setLoading(true);
 
            if (choice) state.history.push({ role: "user", content: `æˆ‘é€‰æ‹©ï¼š${choice}` });
 
            // æ³¨å…¥å½“å‰èµ„äº§ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢ AI äº§ç”Ÿå¹»è§‰
            // è¿™ä¸€æ­¥éå¸¸å…³é”®ï¼šè®© AI çŸ¥é“ç©å®¶ç°åœ¨åˆ°åº•æœ‰å¤šå°‘é’±
            state.history.push({
                role: "system",
                content: `[ç³»ç»Ÿç›‘æµ‹] å½“å‰ä½™é¢ï¼š${state.money}å…ƒã€‚å¥åº·ï¼š${state.health}ã€‚è‹¥ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜é€‰é¡¹ï¼Œè¯·è§¦å‘ç ´äº§æˆ–å€Ÿè´·å‰§æƒ…ã€‚`
            });
 
            // å¯¼æ¼”æœºåˆ¶ï¼šéšæœºæ³¨å…¥å¼ºåˆ¶äº‹ä»¶ (20%æ¦‚ç‡)
            let injectedEvent = null;
            if (Math.random() < 0.20 && state.money > 0 && !choice?.includes("æ¸¸æˆå¼€å§‹")) {
                const evt = GLOBAL_EVENTS[Math.floor(Math.random() * GLOBAL_EVENTS.length)];
                injectedEvent = evt;
                state.history.push({
                    role: "system",
                    content: `ã€å¼ºåˆ¶äº‹ä»¶è§¦å‘ã€‘æœ¬å›åˆå‘ç”Ÿäº†çªå‘äº‹ä»¶ï¼š"${evt.text}"ã€‚è¯·å¿½ç•¥ä¹‹å‰çš„å¹³ç¨³å‘å±•ï¼Œå¿…é¡»åŸºäºè¿™ä¸ªç¾éš¾äº‹ä»¶ç¼–å†™æœ¬å›åˆå‰§æƒ…å’Œé€‰é¡¹ï¼Œå¹¶å¤§å¹…æ‰£é™¤ç›¸åº”é‡‘é’±æˆ–å±æ€§ã€‚`
                });
            }
 
            try {
                const res = await fetch(`${api.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${api.key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "deepseek-chat", // é€‚é…æ·±åº¦æ±‚ç´¢ API
                        messages: state.history,
                        temperature: 0.9,
                        response_format: { type: "json_object" }
                    })
                });
 
                const data = await res.json();
                let content = data.choices[0].message.content.replace(/```json|```/g, '').trim();
                const gameData = JSON.parse(content);
 
                // è®°å½• AI å›å¤ï¼ˆå‰”é™¤ç³»ç»Ÿæ³¨å…¥çš„ä¸´æ—¶æŒ‡ä»¤ï¼Œä¿æŒå†å²å¹²å‡€ï¼‰
                // è¿™é‡Œç®€å•å¤„ç†ï¼Œç›´æ¥push content
                state.history.push({ role: "assistant", content: content });
 
                processTurn(gameData, injectedEvent);
 
            } catch (e) {
                console.error(e);
                appendStory(`<span class="text-red-500">è¿æ¥ä¸­æ–­...è¯·æ£€æŸ¥ç½‘ç»œæˆ–API Key</span>`);
            } finally {
                setLoading(false);
            }
        }
 
        function processTurn(data, evt) {
            // æ›´æ–°æ•°å€¼
            if (data.diff) applyDiff(data.diff);
 
            // è®°å½•æ—¶é—´çº¿
            if (data.timeline) state.timeline.push(data.timeline);
 
            // å¾½ç« ç³»ç»Ÿ
            if (data.new_milestones) {
                data.new_milestones.forEach(m => {
                    if (!state.milestones.includes(m)) {
                        state.milestones.push(m);
                        addMilestoneUI(m);
                    }
                });
            }
            if (evt && !state.milestones.includes(evt.id)) {
                addMilestoneUI(evt.id);
            }
 
            // æ›´æ–° UI
            updateUI();
 
            // å‰§æƒ…æ¸²æŸ“
            let storyHtml = data.story;
            if (evt) {
                storyHtml = `<strong class="text-red-400 block mb-2">[çªå‘] ${evt.text.split('ã€‘')[0]}ã€‘</strong>${data.story}`;
            }
            appendStory(storyHtml);
 
            // æ£€æŸ¥ç»“å±€
            if (data.game_over || state.money < -500000 || state.health <= 0) {
                setTimeout(() => showEnding(data.ending || { title: "è’å”ä¸€ç”Ÿ", rank: "C" }), 2000);
            } else {
                renderOptions(data.options || ["é™è§‚å…¶å˜"]);
            }
        }
 
        function applyDiff(diff) {
            // Money Text - å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ï¼Œé˜²æ­¢å­—ç¬¦ä¸²æ‹¼æ¥é”™è¯¯
            const moneyChange = Number(diff.money) || 0;
 
            if (moneyChange !== 0) {
                state.money += moneyChange;
                const text = moneyChange > 0 ? `+Â¥${formatShort(moneyChange)}` : `-Â¥${formatShort(Math.abs(moneyChange))}`;
                const color = moneyChange > 0 ? 'text-green-400' : 'text-red-500';
                showFloat(text, color);
            }
 
            // Stats
            const update = (k, v, color) => {
                const val = Number(v) || 0;
                if (!val) return;
                state[k] = Math.min(100, Math.max(0, state[k] + val));
                showFloat(`${k === 'happiness' ? 'ä¹' : (k === 'health' ? 'å¥' : 'å')} ${val > 0 ? '+' : ''}${val}`, color);
            };
            update('happiness', diff.happiness, 'text-pink-400');
            update('health', diff.health, 'text-emerald-400');
            update('reputation', diff.reputation, 'text-blue-400');
            state.age += (Number(diff.age) || 0);
        }
 
        function updateUI() {
            // Header
            document.getElementById('moneyDisplay').innerText = formatMoney(state.money);
            document.getElementById('moneyDisplay').className = state.money < 0 ? "font-mono font-bold text-lg text-red-500" : "font-mono font-bold text-lg text-yellow-400";
            document.getElementById('ageDisplay').innerText = Math.floor(state.age);
 
            document.getElementById('valHappy').innerText = Math.floor(state.happiness);
            document.getElementById('barHappy').style.width = state.happiness + "%";
            document.getElementById('valHealth').innerText = Math.floor(state.health);
            document.getElementById('barHealth').style.width = state.health + "%";
            document.getElementById('valRep').innerText = Math.floor(state.reputation);
            document.getElementById('barRep').style.width = state.reputation + "%";
 
            // Avatar Logic
            let seed = `${state.gender}-${Math.floor(state.age / 5)}`;
            if (state.money > 50000000) seed += "-rich";
            if (state.money < 0) seed += "-poor";
            if (state.milestones.includes('jail')) seed = "jail";
 
            const url = `${CONFIG.avatarHost}?seed=${seed}&backgroundColor=b6e3f4,c0aede,ffdfbf`;
            document.getElementById('headerAvatar').src = url;
            document.getElementById('drawerAvatar').src = url;
        }
 
        function appendStory(html) {
            const container = document.getElementById('storyLog');
            const div = document.createElement('div');
            div.className = "bg-[#111] border-l-2 border-yellow-700 p-4 rounded-r-xl text-sm md:text-base leading-relaxed text-gray-300 shadow-md fade-in";
            div.innerHTML = html;
            container.appendChild(div);
            scrollToBottom();
        }
 
        function scrollToBottom() {
            const main = document.getElementById('storyContainer');
            setTimeout(() => {
                main.scrollTo({ top: main.scrollHeight, behavior: 'smooth' });
            }, 100);
        }
 
        function renderOptions(opts) {
            const box = document.getElementById('choicesBox');
            box.innerHTML = '';
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-[#151515] p-4 rounded-xl text-sm text-gray-200 border border-gray-800 active:bg-yellow-800 active:border-yellow-500 transition slide-up shadow-sm group";
                btn.innerHTML = `<span class="text-yellow-700 group-hover:text-yellow-500 mr-2">â¤</span>${opt}`;
                btn.onclick = () => fetchTurn(opt);
                box.appendChild(btn);
            });
        }
 
        function showFloat(text, color) {
            const overlay = document.getElementById('floatOverlay');
            const el = document.createElement('div');
            el.className = `absolute text-2xl font-black ${color} float-anim drop-shadow-md z-50`;
            el.style.left = (20 + Math.random() * 60) + '%';
            el.style.top = (40 + Math.random() * 20) + '%';
            el.innerText = text;
            overlay.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }
 
        const BADGE_ICONS = {
            'married': 'ğŸ’ ç»“å©š', 'jail': 'â›“ï¸ é“çª—', 'bankrupt': 'ğŸ“‰ ç ´äº§',
            'luxury_car': 'ğŸï¸ è±ªè½¦', 'house': 'ğŸ  è±ªå®…', 'scam': 'ğŸ· è¢«éª—',
            'sugar_daddy': 'ğŸ’‹ åŒ…å…»', 'charity': 'â¤ï¸ æ…ˆå–„', 'ceo': 'ğŸ’¼ æ€»è£'
        };
 
        function addMilestoneUI(key) {
            document.getElementById('badgeDot').classList.remove('hidden');
            const list = document.getElementById('milestoneList');
            const label = BADGE_ICONS[key] || ('ğŸ† ' + key);
            const el = document.createElement('span');
            el.className = "inline-flex items-center px-2 py-1 bg-yellow-900/40 border border-yellow-700 text-yellow-100 text-xs rounded pop-in";
            el.innerText = label;
            list.appendChild(el);
        }
 
        function showEnding(endData) {
            const screen = document.getElementById('endScreen');
            document.getElementById('gameUI').style.display = 'none';
            screen.classList.remove('hidden');
            screen.classList.add('flex');
 
            document.getElementById('endName').innerText = state.gender === 'male' ? 'Mr. Player' : 'Ms. Player';
            document.getElementById('endJob').innerText = state.originalJob;
            document.getElementById('endAge').innerText = Math.floor(state.age);
            document.getElementById('endTitle').innerText = endData.title;
            document.getElementById('endMoney').innerText = "Â¥" + formatMoney(state.money);
            document.getElementById('endRank').innerText = endData.rank || "C";
 
            const ul = document.getElementById('endTimeline');
            state.timeline.slice(-10).forEach(t => {
                const li = document.createElement('li');
                li.innerText = "> " + t;
                ul.appendChild(li);
            });
        }
 
        // Helpers
        function toggleProfile() {
            const d = document.getElementById('profileDrawer');
            if (d.classList.contains('hidden')) {
                d.classList.remove('hidden'); d.classList.add('flex');
                document.getElementById('badgeDot').classList.add('hidden');
            } else {
                d.classList.add('hidden'); d.classList.remove('flex');
            }
        }
        function setLoading(b) {
            const l = document.getElementById('loadingBox');
            const c = document.getElementById('choicesBox');
            if (b) { l.classList.remove('hidden'); c.classList.add('hidden'); }
            else { l.classList.add('hidden'); c.classList.remove('hidden'); }
        }
 
        // ä¼˜åŒ–é‡‘é¢æ˜¾ç¤ºé€»è¾‘ï¼Œé¿å… 500w æ˜¾ç¤ºæˆ 500.0ä¸‡ è¿™ç§å°´å°¬æ ¼å¼
        function formatMoney(n) {
            const absN = Math.abs(n);
            if (absN >= 100000000) return (n / 100000000).toFixed(2) + "äº¿"; // 1äº¿ä»¥ä¸Š
            if (absN >= 10000) return (n / 10000).toFixed(1) + "ä¸‡";    // 1ä¸‡ä»¥ä¸Š
            return n.toLocaleString();                                  // 1ä¸‡ä»¥ä¸‹æ˜¾ç¤ºå…¨é¢
        }
 
        function formatShort(n) {
            if (n >= 100000000) return (n / 100000000).toFixed(1) + "äº¿";
            if (n >= 10000) return (n / 10000).toFixed(0) + "ä¸‡";
            return n;
        }
    </script>
</body>
 
</html>