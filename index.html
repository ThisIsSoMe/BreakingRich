<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¯Œè±ªæ¨¡æ‹Ÿå™¨ V8.1 - è¿™é‡Œçš„é»æ˜é™æ‚„æ‚„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        /* å…¨å±€è®¾å®š */
        body, html { height: 100%; width: 100%; overflow: hidden; background-color: #050505; color: #e5e5e5; font-family: 'Noto Serif SC', serif; }
        .mono { font-family: 'JetBrains+Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
 
        /* åŠ¨ç”» */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes floatChange { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.1); opacity: 0; } }
        .float-anim { animation: floatChange 1.5s ease-out forwards; pointer-events: none; z-index: 50; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); }
 
        /* èŠå¤©æ°”æ³¡ */
        .chat-bubble-me { background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%); color: white; border-radius: 12px 12px 0 12px; }
        .chat-bubble-npc { background: #1f2937; color: #e5e5e5; border-radius: 12px 12px 12px 0; }
        
        /* ç»“ç®—å°ç¥¨ */
        .receipt-bg { background-color: #fff; background-image: radial-gradient(#eee 1px, transparent 1px); background-size: 10px 10px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        .jagged-edge { background: linear-gradient(-45deg, transparent 8px, #fff 8px), linear-gradient(45deg, transparent 8px, #fff 8px); background-size: 16px 16px; height: 16px; width: 100%; }
    </style>
</head>
 
<body class="flex flex-col h-full bg-gray-950">
 
    <!-- 1. åˆå§‹åŒ–å¼¹çª— -->
    <div id="initModal" class="fixed inset-0 z-[60] bg-black flex flex-col justify-center px-6 transition-opacity duration-500">
        <div class="w-full max-w-md mx-auto bg-gray-900 p-6 rounded-2xl border border-gray-800 shadow-2xl space-y-6 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-600 rounded-full blur-[50px] opacity-20"></div>
            <div class="text-center relative z-10">
                <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-600 tracking-wider">æ¬²æœ›éƒ½å¸‚</h1>
                <p class="text-xs text-gray-500 mt-2 tracking-[0.2em] uppercase">Wealth & Desire V8.1</p>
            </div>
            <div class="space-y-4 relative z-10">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1 uppercase">Gender</label>
                        <select id="genderInput" class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600">
                            <option value="male">ç”· (Male)</option>
                            <option value="female">å¥³ (Female)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block mb-1 uppercase">Job</label>
                        <input type="text" id="jobInput" placeholder="ä¾‹: 996æ‰“å·¥äºº" class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1 uppercase">API Key (DeepSeek/OpenAI)</label>
                    <input type="text" id="apiKeyInput" placeholder="sk-..." class="w-full bg-black border border-gray-700 text-white rounded-lg p-3 text-sm outline-none focus:border-yellow-600">
                </div>
                <input type="text" id="apiBaseUrl" value="https://api.deepseek.com" class="w-full bg-transparent border-b border-gray-800 text-[10px] text-gray-700 p-1 text-center outline-none">
            </div>
            <button onclick="startGame()" class="w-full bg-gradient-to-r from-yellow-700 to-yellow-600 text-white font-bold py-4 rounded-xl shadow-lg relative z-10">è¿›å…¥ååˆ©åœº â¤</button>
        </div>
    </div>
 
    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="gameUI" class="hidden flex-col h-full w-full max-w-lg mx-auto relative overflow-hidden bg-[#0a0a0a]">
        
        <!-- A. é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="flex-none bg-gray-900/90 border-b border-gray-800 p-3 z-30 backdrop-blur-md">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3" onclick="toggleProfile()">
                    <div class="relative">
                        <div class="w-11 h-11 rounded-full p-[2px] bg-gradient-to-tr from-yellow-500 to-transparent">
                            <img id="headerAvatar" src="" class="w-full h-full rounded-full object-cover bg-gray-800">
                        </div>
                        <div id="badgeDot" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-gray-900"></div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-500 uppercase">Assets</div>
                        <div id="moneyDisplay" class="font-mono font-bold text-lg text-yellow-400 leading-none">10,000,000</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase">Age</div>
                    <div id="ageDisplay" class="font-serif font-bold text-xl text-white leading-none">22</div>
                </div>
            </div>
            <!-- å±æ€§æ¡ -->
            <div class="grid grid-cols-3 gap-3">
                <div class="space-y-1"><div class="flex justify-between text-[10px] text-gray-400"><span>ä¹</span><span id="valHappy">80</span></div><div class="h-1 bg-gray-800 rounded-full"><div id="barHappy" class="h-full bg-pink-500 transition-all" style="width: 80%"></div></div></div>
                <div class="space-y-1"><div class="flex justify-between text-[10px] text-gray-400"><span>å¥</span><span id="valHealth">90</span></div><div class="h-1 bg-gray-800 rounded-full"><div id="barHealth" class="h-full bg-emerald-500 transition-all" style="width: 90%"></div></div></div>
                <div class="space-y-1"><div class="flex justify-between text-[10px] text-gray-400"><span>å</span><span id="valRep">50</span></div><div class="h-1 bg-gray-800 rounded-full"><div id="barRep" class="h-full bg-blue-500 transition-all" style="width: 50%"></div></div></div>
            </div>
        </header>
 
        <!-- Tab åˆ‡æ¢ -->
        <div class="flex-none grid grid-cols-2 bg-gray-900 border-b border-gray-800 text-sm font-bold z-20">
            <button onclick="switchTab('story')" id="tabStory" class="py-3 text-yellow-500 border-b-2 border-yellow-500 transition-colors">å‰§æƒ… (Story)</button>
            <button onclick="switchTab('chat')" id="tabChat" class="py-3 text-gray-500 border-b-2 border-transparent transition-colors relative">
                é€šè®¯å½• (Contacts)
                <span id="chatRedDot" class="hidden absolute top-2 right-8 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
        </div>
 
        <!-- B. å‰§æƒ…æµ -->
        <main id="storyContainer" class="flex-1 min-h-0 overflow-y-auto p-4 relative scroll-smooth bg-[#0a0a0a]">
            <div id="storyLog" class="space-y-6 pb-32"></div>
        </main>
 
        <!-- C. é€šè®¯å½•ç•Œé¢ (é»˜è®¤éšè—) -->
        <main id="contactsContainer" class="hidden flex-1 min-h-0 overflow-y-auto bg-[#0a0a0a] pb-32">
            <div id="emptyContacts" class="text-center text-gray-600 mt-20 text-xs">
                <p>æš‚æ— è”ç³»äºº</p>
                <p>éšç€å‰§æƒ…å‘å±•ï¼Œä½ ä¼šé‡åˆ°å„è‰²äººç‰©</p>
            </div>
            <div id="contactsList" class="divide-y divide-gray-800">
                <!-- è”ç³»äººåˆ—è¡¨é¡¹å°†æ’å…¥è¿™é‡Œ -->
            </div>
        </main>
 
        <!-- æµ®åŠ¨ç‰¹æ•ˆ -->
        <div id="floatOverlay" class="absolute inset-0 pointer-events-none overflow-hidden z-40"></div>
 
        <!-- D. åº•éƒ¨æ“ä½œæ  -->
        <footer id="actionFooter" class="flex-none bg-gray-900 border-t border-gray-800 p-4 z-30 pb-8">
            <div id="loadingBox" class="hidden w-full py-4 text-center">
                <span class="text-yellow-600 text-xs font-mono animate-pulse tracking-widest">>>> AI COMPUTING...</span>
            </div>
            <div id="choicesBox" class="flex flex-col gap-2.5 max-h-[45vh] overflow-y-auto no-scrollbar"></div>
        </footer>
 
        <!-- E. èŠå¤©çª—å£è¯¦æƒ…é¡µ (è¦†ç›–å±‚) -->
        <div id="chatRoom" class="fixed inset-0 z-[100] bg-black hidden flex-col transition-transform duration-300 translate-x-full">
            <!-- èŠå¤©å¤´ -->
            <div class="flex-none bg-gray-900 p-4 flex items-center gap-4 border-b border-gray-800 pt-12">
                <button onclick="closeChat()" class="text-gray-400 hover:text-white">â†</button>
                <div class="flex-1">
                    <h3 id="chatRoomName" class="font-bold text-white">Name</h3>
                    <p id="chatRoomRelation" class="text-[10px] text-gray-500">Relation</p>
                </div>
                <div class="text-[10px] text-yellow-600 border border-yellow-800 px-2 rounded">äº²å¯†åº¦ <span id="chatRoomIntimacy">0</span></div>
            </div>
            
            <!-- èŠå¤©è®°å½• -->
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#0d0d0d]"></div>
 
            <!-- è¾“å…¥æ¡† -->
            <div class="flex-none bg-gray-900 p-3 pb-8 border-t border-gray-800 flex gap-2">
                <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 bg-black border border-gray-700 text-white rounded-lg px-4 text-sm outline-none focus:border-yellow-600">
                <button onclick="sendChatMessage()" class="bg-yellow-700 text-white px-4 rounded-lg font-bold text-sm">å‘é€</button>
            </div>
        </div>
 
    </div>
 
    <!-- 3. ç»“ç®—å°ç¥¨ -->
    <div id="endScreen" class="hidden fixed inset-0 bg-gray-900 z-[70] overflow-y-auto flex items-start justify-center pt-10 pb-10">
        <div class="receipt-bg text-black font-mono w-[90%] max-w-md shadow-2xl relative fade-in">
            <div class="jagged-edge absolute -top-4 left-0 transform rotate-180"></div>
            <div class="p-6 pb-10">
                <div class="text-center border-b-2 border-black pb-4 mb-4">
                    <h2 class="text-3xl font-black uppercase tracking-tighter">äººç”Ÿç»“ç®—å•</h2>
                    <p class="text-[10px] text-gray-500 mt-1">LIFE SIMULATION RECEIPT</p>
                </div>
                <div class="space-y-2 text-xs mb-6 font-bold text-gray-800">
                    <div class="flex justify-between"><span>NAME</span><span id="endName">---</span></div>
                    <div class="flex justify-between"><span>ENDING</span><span id="endTitle" class="bg-black text-white px-1">---</span></div>
                </div>
                <div class="border-t-4 border-black pt-4 mb-6">
                    <div class="flex justify-between items-end"><span class="text-xs font-bold">TOTAL ASSETS</span><span class="text-xl font-black" id="endMoney">Â¥0</span></div>
                    <div class="flex justify-between items-end mt-1"><span class="text-xs font-bold">SCORE</span><span class="text-xl font-black" id="endRank">C</span></div>
                </div>
            </div>
            <div class="jagged-edge absolute -bottom-4 left-0"></div>
        </div>
        <div class="fixed bottom-6 w-full px-6 max-w-md">
            <button onclick="location.reload()" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-xl shadow-xl">é‡å¯äººç”Ÿ</button>
        </div>
    </div>
 
    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const CONFIG = { avatarHost: "https://api.dicebear.com/9.x/notionists/svg" };
        let state = {
            money: 100000000, happiness: 80, health: 90, reputation: 50, age: 22,
            gender: 'male', originalJob: '',
            milestones: [], timeline: [], history: [],
            // æ–°å¢ï¼šè”ç³»äººæ•°æ®
            contacts: {} // ID: { name, relation, desc, intimacy, history: [], avatar }
        };
        let api = { key: '', url: '' };
        let currentChatId = null; // å½“å‰æ­£åœ¨èŠå¤©çš„è”ç³»äººID
 
        // éšæœºäº‹ä»¶åº“ï¼ˆåˆ†æ€§åˆ«ï¼‰
        const GLOBAL_EVENTS = {
            common: [
                { id: "tax_audit", text: "ã€ç¨åŠ¡ç¨½æŸ¥ã€‘ä½ è¢«ä¸¾æŠ¥å­˜åœ¨å·¨é¢å·ç¨æ¼ç¨ï¼Œè´¦æˆ·è¢«å†»ç»“..." },
                { id: "market_crash", text: "ã€é‡‘èæµ·å•¸ã€‘ä½ çš„ç†è´¢äº§å“å’Œè‚¡ç¥¨å…¨çº¿é£˜ç»¿ï¼Œèµ„äº§ç¼©æ°´..." },
                { id: "relative", text: "ã€äº²æˆšå¸è¡€ã€‘è€å®¶æ¥äº†ä¸€å¸®äº²æˆšï¼Œèµ–åœ¨ä½ å®¶ä¸èµ°ï¼Œéè¦ä½ ç»™å®‰æ’å·¥ä½œ..." }
            ],
            male: [
                { id: "scam", text: "ã€ä»™äººè·³ã€‘æ˜¨æ™šå¸¦å›å®¶çš„ç¾å¥³ï¼Œä»Šå¤©å£°ç§°æœªæˆå¹´å¹¶æŠ¥äº†è­¦..." },
                { id: "gamble", text: "ã€æ¾³é—¨é£äº‘ã€‘ä½ åœ¨è´µå®¾å…ä¸Šå¤´äº†ï¼Œä¸€å¤œè¾“æ‰äº†ä¸‰å¥—æˆ¿..." }
            ],
            female: [
                { id: "plastic_fail", text: "ã€åŒ»ç¾äº‹æ•…ã€‘è´ªä¾¿å®œæ‰“çš„'ç«¥é¢œé’ˆ'å¯¼è‡´é¢éƒ¨åƒµç¡¬æºƒçƒ‚ï¼Œæ€¥éœ€å·¨é¢ä¿®å¤è´¹..." },
                { id: "pua", text: "ã€æ€çŒªç›˜ã€‘é‚£ä¸ªå¯¹ä½ æ— å¾®ä¸è‡³çš„'é‡‘èæ‰ä¿Š'ç”·å‹ï¼Œå·èµ°äº†ä½ è”åè´¦æˆ·é‡Œæ‰€æœ‰çš„é’±..." },
                { id: "fake_bag", text: "ã€å‡åŒ…ååª›ã€‘ä½ èƒŒç€ä»£è´­ä¹°çš„å–œé©¬æ‹‰é›…é“‚é‡‘åŒ…å»èšä¼šï¼Œè¢«å½“åœºé‰´å®šä¸ºå‡è´§ï¼Œé­åˆ°ååª›åœˆå°æ€..." },
                { id: "bestie_betray", text: "ã€é—ºèœœèƒŒåˆºã€‘ä½ æœ€å¥½çš„é—ºèœœæŠŠä½ æ•´å®¹å‰çš„ç…§ç‰‡å’Œç§å¯†èŠå¤©è®°å½•å‘åˆ°äº†ç½‘ä¸Š..." }
            ]
        };
 
        // --- åˆå§‹åŒ– ---
        function startGame() {
            const job = document.getElementById('jobInput').value.trim();
            const key = document.getElementById('apiKeyInput').value.trim();
            let url = document.getElementById('apiBaseUrl').value.trim();
 
            if (!job || !key) { alert("è¯·å®Œå–„ä¿¡æ¯ï¼"); return; }
            if (url.endsWith('/')) url = url.slice(0, -1);
            if (!url.endsWith('/v1')) url += '/v1';
 
            state.originalJob = job;
            state.gender = document.getElementById('genderInput').value;
            api = { key, url };
 
            // å·®å¼‚åŒ–åˆå§‹è”ç³»äºº
            if (state.gender === 'male') {
                addContact({ name: "ææ€»", relation: "é…’è‚‰æœ‹å‹", desc: "æ€»å«ä½ å»æ´—è„šåŸ", avatar_seed: "boss_li" }, true);
                addContact({ name: "å‰å¥³å‹", relation: "æ—§çˆ±", desc: "å¬è¯´ä½ æœ‰é’±äº†çªç„¶è¯ˆå°¸", avatar_seed: "ex_gf" }, true);
            } else {
                addContact({ name: "Kevinè€å¸ˆ", relation: "Tonyæ€»ç›‘", desc: "æŸé«˜æ¡£æ²™é¾™å‘å‹å¸ˆï¼Œå˜´å¾ˆç”œ", avatar_seed: "kevin" }, true);
                addContact({ name: "Jessica", relation: "ååª›é—ºèœœ", desc: "è¡¨é¢å§å¦¹ï¼Œæš—åœ°æ”€æ¯”", avatar_seed: "jessica" }, true);
                addContact({ name: "å¦ˆå¦ˆ", relation: "äº²äºº", desc: "å‚¬ä½ èµ¶ç´§æ‰¾ä¸ªè±ªé—¨å«äº†", avatar_seed: "mom" }, true);
            }
 
            document.getElementById('initModal').style.display = 'none';
            document.getElementById('gameUI').classList.remove('hidden');
            document.getElementById('gameUI').classList.add('flex');
            updateUI();
            initGameStory();
        }
 
        // --- Tab åˆ‡æ¢é€»è¾‘ ---
        function switchTab(tab) {
            const storyEl = document.getElementById('storyContainer');
            const chatEl = document.getElementById('contactsContainer');
            const storyBtn = document.getElementById('tabStory');
            const chatBtn = document.getElementById('tabChat');
            const footer = document.getElementById('actionFooter');
 
            if (tab === 'story') {
                storyEl.classList.remove('hidden');
                chatEl.classList.add('hidden');
                storyBtn.classList.add('text-yellow-500', 'border-yellow-500');
                storyBtn.classList.remove('text-gray-500', 'border-transparent');
                chatBtn.classList.add('text-gray-500', 'border-transparent');
                chatBtn.classList.remove('text-yellow-500', 'border-yellow-500');
                footer.classList.remove('hidden'); 
            } else {
                storyEl.classList.add('hidden');
                chatEl.classList.remove('hidden');
                storyBtn.classList.remove('text-yellow-500', 'border-yellow-500');
                storyBtn.classList.add('text-gray-500', 'border-transparent');
                chatBtn.classList.remove('text-gray-500', 'border-transparent');
                chatBtn.classList.add('text-yellow-500', 'border-yellow-500');
                footer.classList.add('hidden'); 
                document.getElementById('chatRedDot').classList.add('hidden'); 
            }
        }
 
        // --- å‰§æƒ…å¼•æ“ ---
        function initGameStory() {
            // å·®å¼‚åŒ– Prompt
            const maleDesire = "æ ¸å¿ƒä¸»é¢˜ï¼šæƒåŠ›ã€ç¾å¥³ã€è±ªè½¦ã€èµŒåšã€‚å…¸å‹äº‹ä»¶ï¼šåŒ…å…»å«©æ¨¡ã€å»å¤œæ€»ä¼šæŒ¥éœã€è¢«æ‹œé‡‘å¥³æ¬ºéª—ã€æŠ•èµ„å¤±è´¥ã€ç§ç”Ÿå­æ‰¾ä¸Šé—¨ã€‚é£æ ¼ï¼šç‹‚å¦„ã€ç›´æ¥ã€å……æ»¡é›„æ€§è·å°”è’™çš„æ¯ç­ã€‚";
            const femaleDesire = "æ ¸å¿ƒä¸»é¢˜ï¼šç¾è²Œã€è™šè£ã€æƒ…æ„Ÿæ§åˆ¶ã€ååª›ç¤¾äº¤ã€‚å…¸å‹äº‹ä»¶ï¼šæ²‰è¿·æ•´å®¹åŒ»ç¾ã€åŒ…å…»å°å¥¶ç‹—(ç”·æ¨¡)ã€è´­ä¹°çˆ±é©¬ä»•é…è´§ã€è¢«æ€çŒªç›˜PUAã€é—ºèœœæ’•é€¼ã€å«å…¥è±ªé—¨åçš„å©†åª³å¤§æˆ˜ã€‚é£æ ¼ï¼šç²¾è‡´ã€ç”šè‡³ç•¥å¸¦ç¥ç»è´¨çš„ç–¯ç‹‚ï¼Œå…³æ³¨å¤–è²Œç„¦è™‘å’Œæƒ…æ„Ÿçº è‘›ã€‚";
 
            const specificPrompt = state.gender === 'male' ? maleDesire : femaleDesire;
 
            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ª"å¯Œè±ªæ¨¡æ‹Ÿå™¨"æ¸¸æˆå¼•æ“ã€‚ç©å®¶ï¼š${state.gender}, 22å², åŸèŒä¸š${state.originalJob}, ç°é‡‘1äº¿ã€‚
 
**æ¸¸æˆåŸºè°ƒ**ï¼š${specificPrompt}
 
**æ ¸å¿ƒä»»åŠ¡**ï¼š
1. å‰§æƒ…åå‘é»‘è‰²å¹½é»˜ã€‚
2. **ç¤¾äº¤ç³»ç»Ÿï¼ˆé‡è¦ï¼‰**ï¼šå¦‚æœå‰§æƒ…ä¸­é‡åˆ°äº†å…·ä½“çš„æ–°äººç‰©ï¼ˆå¦‚æ­è®ªçš„å¼‚æ€§ã€æ¨é”€çš„æŸœå§ã€ä»‹ç»ç†è´¢çš„æœ‹å‹ï¼‰ï¼Œè¯·åœ¨JSONä¸­è¿”å› "new_contacts" å­—æ®µã€‚
3. **æ•°å€¼è®¡ç®—**ï¼šdiff.money å¿…é¡»ä¸ºæ•´æ•°ã€‚ä¸¥ç¦ä½¿ç”¨ 'ä¸‡'/'w' ç­‰å•ä½ã€‚
 
**JSONè¾“å‡ºæ ¼å¼**ï¼ˆä¸¥ç¦Markdownï¼‰ï¼š
{
    "story": "å‰§æƒ…æ–‡æœ¬(100å­—å·¦å³)",
    "timeline": "ç®€å†æ‘˜è¦...",
    "diff": { "money": -50000, "happiness": 5, "health": -2, "reputation": 0, "age": 0.5 },
    "new_milestones": ["badge_id"],
    "new_contacts": [
        { "name": "Lisa", "relation": "å¤œåº—è®¤è¯†çš„", "desc": "èº«æç«è¾£", "avatar_seed": "lisa" }
    ],
    "options": ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C"],
    "game_over": false,
    "ending": { "title": "...", "rank": "B" }
}
`;
            state.history = [{ role: "system", content: systemPrompt }, { role: "user", content: "ç¬¬ä¸€å¹•ï¼šæˆ‘çœ‹ç€é“¶è¡Œå¡çš„ä¸€äº¿ä½™é¢ï¼Œå†³å®šå¼€å§‹æŒ¥éœã€‚" }];
            fetchTurn();
        }
 
        async function fetchTurn(choice = null) {
            setLoading(true);
            if (choice) state.history.push({ role: "user", content: `é€‰æ‹©ï¼š${choice}` });
            
            state.history.push({ role: "system", content: `[ç³»ç»Ÿ] ä½™é¢:${state.money}, å¥åº·:${state.health}ã€‚è‹¥é‡åˆ°æ–°è§’è‰²è¯·è¿”å› new_contactsã€‚` });
 
            // å¯¼æ¼”æœºåˆ¶ï¼šéšæœºæ³¨å…¥å¼ºåˆ¶äº‹ä»¶ (20%æ¦‚ç‡)
            let injectedEvent = null;
            if (Math.random() < 0.20 && state.money > 0 && !choice?.includes("ç¬¬ä¸€å¹•")) {
                // åˆå¹¶é€šç”¨äº‹ä»¶å’Œæ€§åˆ«ä¸“å±äº‹ä»¶
                const pool = [...GLOBAL_EVENTS.common, ...(GLOBAL_EVENTS[state.gender] || [])];
                const evt = pool[Math.floor(Math.random() * pool.length)];
                injectedEvent = evt;
                state.history.push({
                    role: "system",
                    content: `ã€å¼ºåˆ¶äº‹ä»¶è§¦å‘ã€‘æœ¬å›åˆå‘ç”Ÿäº†çªå‘äº‹ä»¶ï¼š"${evt.text}"ã€‚è¯·å¿½ç•¥ä¹‹å‰çš„å¹³ç¨³å‘å±•ï¼Œå¿…é¡»åŸºäºè¿™ä¸ªç¾éš¾äº‹ä»¶ç¼–å†™æœ¬å›åˆå‰§æƒ…å’Œé€‰é¡¹ï¼Œå¹¶å¤§å¹…æ‰£é™¤ç›¸åº”é‡‘é’±æˆ–å±æ€§ã€‚`
                });
            }
 
            try {
                const res = await fetch(`${api.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${api.key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "deepseek-chat", messages: state.history, temperature: 0.9, response_format: { type: "json_object" } })
                });
                const data = await res.json();
                const content = data.choices[0].message.content;
                state.history.push({ role: "assistant", content: content }); 
                const gameData = JSON.parse(content);
                processTurn(gameData, injectedEvent);
            } catch (e) {
                console.error(e);
                appendStory(`<span class="text-red-500">ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•</span>`);
            } finally {
                setLoading(false);
            }
        }
 
        function processTurn(data, evt) {
            if (data.diff) applyDiff(data.diff);
            if (data.new_milestones) data.new_milestones.forEach(m => addMilestoneUI(m));
            if (evt && !state.milestones.includes(evt.id)) addMilestoneUI(evt.id);
            
            // å¤„ç†æ–°è”ç³»äºº
            if (data.new_contacts && data.new_contacts.length > 0) {
                data.new_contacts.forEach(c => addContact(c));
                showFloat("æ–°çš„è”ç³»äººå·²æ·»åŠ ï¼", "text-yellow-400");
                document.getElementById('chatRedDot').classList.remove('hidden');
            }
 
            let storyHtml = data.story;
            if (evt) {
                storyHtml = `<strong class="text-red-400 block mb-2">[çªå‘] ${evt.text.split('ã€‘')[0]}ã€‘</strong>${data.story}`;
            }
            appendStory(storyHtml);
            updateUI();
 
            if (data.game_over || state.money < -500000 || state.health <= 0) {
                showEnding(data.ending || { title: "ç ´äº§ç¦»ä¸–", rank: "D" });
            } else {
                renderOptions(data.options || ["ç»§ç»­"]);
            }
        }
 
        // --- è”ç³»äººä¸èŠå¤©ç³»ç»Ÿ ---
        
        function addContact(c, silent = false) {
            const id = Date.now() + Math.random().toString(36).substr(2, 9);
            const seed = c.avatar_seed || c.name;
            const avatarUrl = `${CONFIG.avatarHost}?seed=${seed}&backgroundColor=b6e3f4`;
            
            state.contacts[id] = {
                id: id,
                name: c.name,
                relation: c.relation,
                desc: c.desc,
                intimacy: 10,
                avatar: avatarUrl,
                history: [
                    { role: 'system', content: `ä½ æ˜¯${c.name}ï¼Œä½ å’Œç©å®¶å…³ç³»æ˜¯${c.relation}ã€‚ä½ çš„æ€§æ ¼è®¾å®šï¼š${c.desc}ã€‚ç©å®¶æ€§åˆ«ï¼š${state.gender}ã€‚èŠå¤©æ—¶è¯·ç®€çŸ­å›å¤ï¼Œå¹¶åœ¨åˆé€‚æ—¶æœºå‘ç©å®¶å€Ÿé’±ã€æä¾›æŠ•èµ„å»ºè®®(å¯èƒ½æ˜¯å‘)ã€æƒ…æ„Ÿå‹’ç´¢æˆ–å‘èµ·é‚€çº¦ã€‚` }
                ]
            };
            if (!silent) renderContacts();
        }
 
        function renderContacts() {
            const list = document.getElementById('contactsList');
            const empty = document.getElementById('emptyContacts');
            list.innerHTML = '';
            
            const keys = Object.keys(state.contacts);
            if (keys.length > 0) empty.style.display = 'none';
 
            keys.forEach(key => {
                const c = state.contacts[key];
                const div = document.createElement('div');
                div.className = "flex items-center gap-4 p-4 hover:bg-gray-800 transition cursor-pointer";
                div.onclick = () => openChat(key);
                div.innerHTML = `
                    <img src="${c.avatar}" class="w-12 h-12 rounded-full bg-gray-700">
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h4 class="text-white font-bold">${c.name}</h4>
                            <span class="text-[10px] text-gray-500 border border-gray-700 px-1 rounded">${c.relation}</span>
                        </div>
                        <p class="text-xs text-gray-500 truncate">${c.desc}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }
 
        function openChat(id) {
            currentChatId = id;
            const c = state.contacts[id];
            const room = document.getElementById('chatRoom');
            
            document.getElementById('chatRoomName').innerText = c.name;
            document.getElementById('chatRoomRelation').innerText = c.relation;
            document.getElementById('chatRoomIntimacy').innerText = c.intimacy;
            
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            c.history.forEach(msg => {
                if(msg.role !== 'system') appendChatBubble(msg.role, msg.content);
            });
 
            room.classList.remove('hidden');
            setTimeout(() => { 
                room.classList.remove('translate-x-full');
                room.classList.add('translate-x-0');
            }, 10);
        }
 
        function closeChat() {
            const room = document.getElementById('chatRoom');
            room.classList.remove('translate-x-0');
            room.classList.add('translate-x-full');
            setTimeout(() => room.classList.add('hidden'), 300);
            currentChatId = null;
        }
 
        function appendChatBubble(role, text) {
            const container = document.getElementById('chatMessages');
            const div = document.createElement('div');
            const isMe = role === 'user';
            div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `<div class="max-w-[80%] p-3 text-sm ${isMe ? 'chat-bubble-me' : 'chat-bubble-npc'} shadow-md">${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
 
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChatId) return;
 
            appendChatBubble('user', text);
            input.value = '';
            
            const contact = state.contacts[currentChatId];
            contact.history.push({ role: 'user', content: text });
 
            const chatPrompt = [
                ...contact.history,
                { role: 'system', content: `
                    [ç³»ç»ŸæŒ‡ä»¤]
                    è¯·ä»¥${contact.name}çš„èº«ä»½å›å¤ã€‚
                    å¿…é¡»è¿”å›JSONï¼š
                    {
                        "reply": "å›å¤å†…å®¹",
                        "diff": { "money": 0, "happiness": 0, "intimacy": 0 },
                        "event_log": "ç®€çŸ­æè¿°å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆç”¨äºä¸»å‰§æƒ…æ—¥å¿—ï¼‰ï¼Œå¦‚'ç­”åº”ç»™Kevinå……å€¼5ä¸‡'ï¼Œè‹¥æ— åˆ™ç•™ç©º"
                    }
                `}
            ];
 
            try {
                const res = await fetch(`${api.url}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${api.key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: "deepseek-chat", messages: chatPrompt, temperature: 0.9, response_format: { type: "json_object" } })
                });
                
                const data = await res.json();
                const content = JSON.parse(data.choices[0].message.content);
 
                appendChatBubble('assistant', content.reply);
                contact.history.push({ role: 'assistant', content: content.reply });
 
                if (content.diff) {
                    applyDiff(content.diff);
                    if (content.diff.intimacy) {
                        contact.intimacy += content.diff.intimacy;
                        document.getElementById('chatRoomIntimacy').innerText = contact.intimacy;
                    }
                }
 
                if (content.event_log) {
                    state.history.push({ role: "system", content: `[èŠå¤©äº‹ä»¶] ä¸${contact.name}èŠå¤©ç»“æœï¼š${content.event_log}` });
                    appendStory(`<div class="text-xs text-gray-500 bg-gray-900 p-2 rounded">ğŸ’¬ [ç§èŠ] ${contact.name}: ${content.event_log}</div>`);
                }
 
            } catch (e) {
                console.error(e);
                appendChatBubble('assistant', '...');
            }
        }
 
        // --- é€šç”¨å·¥å…·å‡½æ•° ---
        function applyDiff(diff) {
            const moneyChange = Number(diff.money) || 0;
            if (moneyChange !== 0) {
                state.money += moneyChange;
                const text = moneyChange > 0 ? `+Â¥${formatShort(moneyChange)}` : `-Â¥${formatShort(Math.abs(moneyChange))}`;
                showFloat(text, moneyChange > 0 ? 'text-green-400' : 'text-red-500');
            }
            const update = (k, v, color) => {
                const val = Number(v) || 0;
                if (!val) return;
                state[k] = Math.min(100, Math.max(0, state[k] + val));
                showFloat(`${k.substr(0,1).toUpperCase()} ${val>0?'+':''}${val}`, color);
            };
            update('happiness', diff.happiness, 'text-pink-400');
            update('health', diff.health, 'text-emerald-400');
            update('reputation', diff.reputation, 'text-blue-400');
            if(diff.age) state.age += Number(diff.age);
            updateUI();
        }
 
        function updateUI() {
            document.getElementById('moneyDisplay').innerText = formatMoney(state.money);
            document.getElementById('ageDisplay').innerText = Math.floor(state.age);
            document.getElementById('valHappy').innerText = Math.floor(state.happiness);
            document.getElementById('barHappy').style.width = state.happiness + "%";
            document.getElementById('valHealth').innerText = Math.floor(state.health);
            document.getElementById('barHealth').style.width = state.health + "%";
            document.getElementById('valRep').innerText = Math.floor(state.reputation);
            document.getElementById('barRep').style.width = state.reputation + "%";
            
            let seed = `${state.gender}-${Math.floor(state.age/5)}`;
            if(state.money > 50000000) seed+="-rich";
            document.getElementById('headerAvatar').src = `${CONFIG.avatarHost}?seed=${seed}&backgroundColor=b6e3f4`;
        }
 
        function appendStory(html) {
            const container = document.getElementById('storyLog');
            const div = document.createElement('div');
            div.className = "bg-[#111] border-l-2 border-yellow-700 p-4 rounded-r-xl text-sm leading-relaxed text-gray-300 shadow-md fade-in";
            div.innerHTML = html;
            container.appendChild(div);
            document.getElementById('storyContainer').scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }
 
        function renderOptions(opts) {
            const box = document.getElementById('choicesBox');
            box.innerHTML = '';
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-[#151515] p-4 rounded-xl text-sm text-gray-200 border border-gray-800 active:bg-yellow-800 transition slide-up";
                btn.innerHTML = `<span class="text-yellow-700 mr-2">â¤</span>${opt}`;
                btn.onclick = () => fetchTurn(opt);
                box.appendChild(btn);
            });
        }
 
        function showFloat(text, color) {
            const el = document.createElement('div');
            el.className = `absolute text-2xl font-black ${color} float-anim z-50`;
            el.style.left = (20 + Math.random() * 60) + '%';
            el.style.top = (40 + Math.random() * 20) + '%';
            el.innerText = text;
            document.getElementById('floatOverlay').appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }
 
        function addMilestoneUI(key) {
            const BADGE_ICONS = {
                'married': 'ğŸ’ ç»“å©š', 'jail': 'â›“ï¸ é“çª—', 'bankrupt': 'ğŸ“‰ ç ´äº§',
                'luxury_car': 'ğŸï¸ è±ªè½¦', 'house': 'ğŸ  è±ªå®…', 'scam': 'ğŸ· è¢«éª—',
                'sugar_daddy': 'ğŸ’‹ åŒ…å…»', 'plastic_fail': 'ğŸ‘º æ¯å®¹', 'pua': 'ğŸ’” PUA'
            };
            if(state.milestones.includes(key)) return;
            state.milestones.push(key);
            
            document.getElementById('badgeDot').classList.remove('hidden');
            const list = document.getElementById('choicesBox'); 
            // è¿™é‡Œå…¶å®åº”è¯¥æ˜¯åœ¨Profileé‡Œå±•ç¤ºï¼Œç®€åŒ–å¤„ç†
        }
 
        function showEnding(endData) {
            document.getElementById('endScreen').classList.remove('hidden');
            document.getElementById('endScreen').classList.add('flex');
            document.getElementById('endTitle').innerText = endData.title;
            document.getElementById('endMoney').innerText = "Â¥" + formatMoney(state.money);
            document.getElementById('endRank').innerText = endData.rank;
        }
 
        function setLoading(b) {
            const l = document.getElementById('loadingBox');
            const c = document.getElementById('choicesBox');
            if (b) { l.classList.remove('hidden'); c.classList.add('hidden'); }
            else { l.classList.add('hidden'); c.classList.remove('hidden'); }
        }
 
        function toggleProfile() { 
            // ç®€åŒ–ç‰ˆ Profile é€»è¾‘
            const h = document.getElementById('contactsContainer').classList.contains('hidden');
            // è¿™é‡Œå¯ä»¥å¼¹çª—æ˜¾ç¤ºmilestonesï¼Œæˆ–è€…å¤ç”¨ä¹‹å‰çš„ drawer é€»è¾‘
        }
        
        function formatMoney(n) {
            const abs = Math.abs(n);
            if (abs >= 100000000) return (n/100000000).toFixed(2) + "äº¿";
            if (abs >= 10000) return (n/10000).toFixed(1) + "ä¸‡";
            return n.toLocaleString();
        }
        function formatShort(n) { return formatMoney(n); }
 
        window.onload = function(){ renderContacts(); }
    </script>
</body>
</html>